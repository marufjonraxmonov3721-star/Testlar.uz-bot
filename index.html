<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>eFootball Tournament</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ef-dark: #00051a;
            --ef-blue: #001e7a;
            --ef-neon: #dfff00;
            --ef-danger: #ff004c;
            --ef-card: rgba(0, 21, 90, 0.9);
            --ef-text: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--ef-dark);
            color: var(--ef-text);
            margin: 0;
            padding-bottom: 70px;
            background-image: radial-gradient(circle at 50% 50%, var(--ef-blue) 0%, var(--ef-dark) 100%);
            background-attachment: fixed;
        }

        .container { padding: 15px; max-width: 500px; margin: auto; }
        
        /* Typography */
        h1, h2, h3 { font-family: 'Oswald', sans-serif; text-transform: uppercase; color: var(--ef-neon); letter-spacing: 1px; }

        /* Inputs */
        .input-box {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid var(--ef-blue);
            color: white; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box;
        }

        /* eFootball Cards */
        .ef-card {
            background: var(--ef-card); border-left: 5px solid var(--ef-neon);
            padding: 15px; border-radius: 4px; margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* Navigation */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #000; border-top: 3px solid var(--ef-neon);
            display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000;
        }
        .nav-item { text-align: center; font-size: 10px; font-weight: 900; color: #fff; opacity: 0.5; cursor: pointer; }
        .nav-item.active { opacity: 1; color: var(--ef-neon); }

        /* Team Selector Grid */
        .team-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
            max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px;
        }
        .team-item {
            text-align: center; font-size: 10px; padding: 5px; border: 1px solid transparent; opacity: 1;
        }
        .team-item.taken { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        .team-item.taken::after { content: "TANLANGAN"; display: block; color: red; font-size: 7px; font-weight: 900; }
        .team-item.selected { border: 1px solid var(--ef-neon); background: rgba(223,255,0,0.1); }
        .team-item img { width: 35px; height: 35px; object-fit: contain; background: white; border-radius: 4px; }

        /* Buttons */
        .btn {
            width: 100%; padding: 15px; background: var(--ef-neon); color: #000;
            border: none; font-weight: 900; text-transform: uppercase; cursor: pointer;
            clip-path: polygon(0 0, 95% 0, 100% 25%, 100% 100%, 5% 100%, 0 75%);
        }
        .btn:disabled { background: #555; cursor: not-allowed; }

        .screen { display: none; }
        .screen.active { display: block; }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-reg" class="screen">
        <h1>Ro'yxatdan o'tish</h1>
        <div class="ef-card">
            <label>ISM</label>
            <input type="text" id="reg-name" class="input-box" placeholder="Ismingizni kiriting">
            <label>FAMILIYA</label>
            <input type="text" id="reg-surname" class="input-box" placeholder="Familiyangizni kiriting">
            <label>TUG'ILGAN SANA</label>
            <input type="date" id="reg-bday" class="input-box">
            
            <p style="color:var(--ef-neon); font-weight:900; font-size:12px;">JAMOA TANLANG:</p>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button onclick="loadTeams('nation')" class="btn" style="padding:5px; font-size:10px;">DAVLATLAR</button>
                <button onclick="loadTeams('club')" class="btn" style="padding:5px; font-size:10px;">KLUBLAR</button>
            </div>
            <div class="team-grid" id="team-selector">Baza yuklanmoqda...</div>
            <button class="btn" style="margin-top:15px;" onclick="handleRegistration()">SAQLASH</button>
        </div>
    </div>

    <div id="screen-tournaments" class="screen active">
        <h1>Turnirlar</h1>
        <div id="tour-list">
            <div class="ef-card">
                <h3>8 TALIK FORMAT</h3>
                <p>Kirish: 5 000 so'm</p>
                <button class="btn btn-join" onclick="joinTournament(8, 5000)">QATNASHISH</button>
            </div>
            <div class="ef-card">
                <h3>16 TALIK FORMAT</h3>
                <p>Kirish: 10 000 so'm</p>
                <button class="btn btn-join" onclick="joinTournament(16, 10000)">QATNASHISH</button>
            </div>
            <div class="ef-card">
                <h3>32 TALIK FORMAT</h3>
                <p>Kirish: 15 000 so'm</p>
                <button class="btn btn-join" onclick="joinTournament(32, 15000)">QATNASHISH</button>
            </div>
            <div class="ef-card">
                <h3>48 TALIK FORMAT</h3>
                <p>Kirish: 20 000 so'm</p>
                <button class="btn btn-join" onclick="joinTournament(48, 20000)">QATNASHISH</button>
            </div>
        </div>
        
        <div id="payment-modal" style="display:none;" class="ef-card">
            <h2 style="color:red">TO'LOV QILING</h2>
            <p>Karta: <b>4073 4200 6816 5541</b></p>
            <p>Ega: <b>Maruf Raxmonov</b></p>
            <p>Summa: <b id="pay-amount">0</b> so'm</p>
            <button class="btn" onclick="confirmPayment()">TO'LOV QILDIM</button>
        </div>
    </div>

    <div id="screen-ranking" class="screen">
        <h1>Reyting</h1>
        <div id="ranking-list"></div>
    </div>

    <div id="screen-profile" class="screen">
        <h1>Profil</h1>
        <div class="ef-card" id="profile-data">
            </div>
    </div>

    <div id="screen-settings" class="screen">
        <h1>Sozlamalar</h1>
        <div class="ef-card">
            <button class="btn" style="background:var(--ef-danger); color:#fff;" onclick="logout()">LOGOUT</button>
        </div>
    </div>
</div>

<nav class="nav-bar">
    <div class="nav-item active" onclick="nav('tournaments', this)">üèü TURNIRLAR</div>
    <div class="nav-item" onclick="nav('ranking', this)">üèÜ REYTING</div>
    <div class="nav-item" onclick="nav('profile', this)">üë§ PROFIL</div>
    <div class="nav-item" onclick="nav('settings', this)">‚öôÔ∏è SOZLAMALAR</div>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAD1KOT_QH64DDWQ306H5L-xwnWH0k2kUg",
        authDomain: "efootball-11be6.firebaseapp.com",
        databaseURL: "https://efootball-11be6-default-rtdb.firebaseio.com",
        projectId: "efootball-11be6",
        storageBucket: "efootball-11be6.firebasestorage.app",
        messagingSenderId: "989986946120",
        appId: "1:989986946120:web:2c654ac8ca6412f0bbec7d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    const user_id = tg.initDataUnsafe?.user?.id || "DEBUG_USER";

    let userData = null;
    let selectedTeam = null;
    let allTeams = [];
    let takenTeams = [];

    // NAVIGATSIYA
    window.nav = (id, el) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        if(id === 'ranking') loadRanking();
        if(id === 'profile') loadProfile();
    };

    // YOSH VA TUG'ILGAN KUN HISOBI
    function getBirthdayStats(bdayStr) {
        const today = new Date();
        const bday = new Date(bdayStr);
        let age = today.getFullYear() - bday.getFullYear();
        const m = today.getMonth() - bday.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < bday.getDate())) age--;

        let nextBday = new Date(today.getFullYear(), bday.getMonth(), bday.getDate());
        if (today > nextBday) nextBday.setFullYear(today.getFullYear() + 1);
        const diff = Math.ceil((nextBday - today) / (1000 * 60 * 60 * 24));

        return { age, daysLeft: diff, formatted: bday.toLocaleDateString('uz-UZ', {month:'long', year:'numeric'}) };
    }

    // REGISTRATION LOGIC
    window.loadTeams = async (type) => {
        const snap = await get(ref(db, 'available_teams'));
        const usersSnap = await get(ref(db, 'users'));
        takenTeams = [];
        if(usersSnap.exists()){
            Object.values(usersSnap.val()).forEach(u => takenTeams.push(u.teamId));
        }

        allTeams = snap.val() ? Object.values(snap.val()) : [];
        const container = document.getElementById('team-selector');
        container.innerHTML = "";
        
        allTeams.filter(t => t.type === type).forEach(team => {
            const isTaken = takenTeams.includes(team.id);
            const div = document.createElement('div');
            div.className = `team-item ${isTaken ? 'taken' : ''}`;
            div.onclick = () => {
                document.querySelectorAll('.team-item').forEach(i => i.classList.remove('selected'));
                div.classList.add('selected');
                selectedTeam = team;
            };
            div.innerHTML = `<img src="${team.logo}"> <p>${team.name}</p>`;
            container.appendChild(div);
        });
    };

    window.handleRegistration = async () => {
        const name = document.getElementById('reg-name').value;
        const surname = document.getElementById('reg-surname').value;
        const bday = document.getElementById('reg-bday').value;

        if(!name || !surname || !bday || !selectedTeam) return alert("Barcha maydonlarni to'ldiring!");

        const newUser = {
            id: user_id, name, surname, bday,
            teamId: selectedTeam.id, teamName: selectedTeam.name, teamLogo: selectedTeam.logo,
            currentTournament: null
        };

        await set(ref(db, 'users/' + user_id), newUser);
        location.reload();
    };

    // TOURNAMENT LOGIC
    window.joinTournament = async (format, price) => {
        if(userData.currentTournament) return alert("Siz allaqachon turnirga qo'shilgansiz!");
        document.getElementById('pay-amount').innerText = price;
        document.getElementById('payment-modal').style.display = 'block';
        window.currentJoinAttempt = { format, price };
    };

    window.confirmPayment = async () => {
        await update(ref(db, 'users/' + user_id), { 
            currentTournament: window.currentJoinAttempt.format + " Talik" 
        });
        alert("To'lov qabul qilindi! Admin tasdiqlashini kuting.");
        location.reload();
    };

    // RANKING & PROFILE
    function loadRanking() {
        onValue(ref(db, 'users'), (snap) => {
            const list = document.getElementById('ranking-list');
            list.innerHTML = "";
            if(!snap.exists()) return;
            Object.values(snap.val()).forEach(u => {
                list.innerHTML += `
                    <div class="ef-card" style="display:flex; align-items:center; gap:15px;">
                        <img src="${u.teamLogo}" style="width:40px; background:white; border-radius:4px;">
                        <div>
                            <div style="font-weight:900;">${u.name} ${u.surname}</div>
                            <div style="font-size:10px; opacity:0.7;">${u.teamName}</div>
                        </div>
                    </div>`;
            });
        });
    }

    function loadProfile() {
        const stats = getBirthdayStats(userData.bday);
        document.getElementById('profile-data').innerHTML = `
            <div style="text-align:center; margin-bottom:15px;">
                <img src="${userData.teamLogo}" style="width:80px; background:white; padding:5px; border-radius:8px;">
                <h2 style="margin:5px 0;">${userData.name} ${userData.surname}</h2>
            </div>
            <p>üóì Tug'ilgan sana: <b>${stats.formatted}</b></p>
            <p>üéÇ Yosh: <b>${stats.age} yosh</b></p>
            <p>üéâ Tug'ilgan kunga: <b>${stats.daysLeft} kun qoldi</b></p>
            <p>üèü Turnir: <b style="color:var(--ef-neon)">${userData.currentTournament || "Qatnashmayapti"}</b></p>
            <p>üõ° Jamoa: <b>${userData.teamName}</b></p>
        `;
    }

    // CHECK AUTH
    async function checkAuth() {
        const snap = await get(ref(db, 'users/' + user_id));
        if(!snap.exists()) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-reg').classList.add('active');
            document.querySelector('.nav-bar').style.display = 'none';
            loadTeams('nation');
        } else {
            userData = snap.val();
            if(userData.currentTournament) {
                document.querySelectorAll('.btn-join').forEach(b => b.disabled = true);
            }
        }
    }

    checkAuth();
</script>

</body>
</html>
