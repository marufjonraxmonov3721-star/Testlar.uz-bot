<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>eFootball AI Tournament</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --bg: #02040d; --card-bg: #0d111d; --accent: #e1ff00; 
            --konami-red: #e60012; --input-bg: #161b2e;
            --text-white: #ffffff; --text-gray: #8e92a4; --border: #1e2436;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg); font-family: 'Segoe UI', Roboto, sans-serif;
            color: var(--text-white); overflow: hidden;
        }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--konami-red); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .konami-text { font-size: 28px; font-weight: 700; color: white; text-transform: uppercase; margin-bottom: 30px; text-align: center; }
        .spinner { width: 45px; height: 45px; border: 4px solid rgba(255, 255, 255, 0.2); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- MAIN APP --- */
        #main-app { display: none; flex-direction: column; height: 100vh; }
        header { padding: 15px; text-align: center; background: rgba(13, 17, 29, 0.9); border-bottom: 1px solid var(--border); position: relative; }
        header h1 { margin: 0; font-size: 16px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        
        #content-area { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }

        nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--nav-bg); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-gray); text-decoration: none; font-size: 9px; font-weight: bold; text-transform: uppercase; cursor: pointer; }
        .nav-item.active { color: var(--accent); }

        /* --- MATCH CARD --- */
        .match-card { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 20px; margin-bottom: 15px; text-align: center; border: 1px solid var(--accent); }
        .match-vs { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
        .match-team-box { flex: 1; font-size: 14px; font-weight: 900; }
        .match-team-box img { width: 50px; height: 35px; object-fit: contain; margin-bottom: 8px; }
        .vs-label { background: var(--accent); color: #000; padding: 5px 10px; border-radius: 20px; font-weight: 900; font-size: 12px; }

        .upload-area { 
            border: 2px dashed var(--border); border-radius: 15px; padding: 30px; 
            cursor: pointer; transition: 0.3s; background: rgba(255, 255, 255, 0.02);
        }
        .upload-area.processing { pointer-events: none; opacity: 0.6; }
        #preview-img { width: 100%; max-height: 200px; object-fit: contain; margin-top: 15px; display: none; border-radius: 10px; }
        #ai-status { font-size: 12px; color: var(--accent); margin-top: 15px; font-weight: bold; }

        .btn-rules { width: 100%; background: var(--accent); color: #000; border: none; padding: 12px; border-radius: 10px; font-size: 12px; font-weight: 900; text-transform: uppercase; margin-bottom: 15px; }
        #rules-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; padding: 25px; width: 100%; max-width: 400px; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="konami-text">eFootball AI Processor</div>
        <div class="spinner"></div>
    </div>

    <div id="registration-screen">
        </div>

    <div id="main-app">
        <header><h1 id="page-title">Mening O'yinlarim</h1></header>
        <div id="content-area"></div>
        <nav>
            <div class="nav-item active" id="nav-matches" onclick="switchPage('matches', this)"><span>O'yinlar</span></div>
            <div class="nav-item" id="nav-tournaments" onclick="switchPage('tournaments', this)"><span>Turnirlar</span></div>
            <div class="nav-item" id="nav-profile" onclick="switchPage('profile', this)"><span>Profil</span></div>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBBAgR6Y5pjtxrb5Xj4YaKGMnPz3MpvT9A",
            authDomain: "efootball-d72ae.firebaseapp.com",
            databaseURL: "https://efootball-d72ae-default-rtdb.firebaseio.com",
            projectId: "efootball-d72ae",
            appId: "1:945307600187:web:995dd8f014077d0b0b231e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let userData = null;
        let allTournaments = {};
        let myTournamentId = null;
        let myTeam = null;
        const userId = tg.initDataUnsafe?.user?.id || "user_test";

        async function startAppInit() {
            const [pSnap, tSnap] = await Promise.all([
                get(ref(db, 'players/' + userId)),
                get(ref(db, 'tournaments'))
            ]);
            if (pSnap.exists()) userData = pSnap.val();
            allTournaments = tSnap.val() || {};
            
            // Turnir va Jamoani aniqlash
            Object.keys(allTournaments).forEach(id => {
                const team = (allTournaments[id].teams || []).find(t => t.player_id == userId);
                if (team) { myTournamentId = id; myTeam = team; }
            });

            document.getElementById('splash-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            switchPage('matches', document.getElementById('nav-matches'));
        }

        window.switchPage = function(page, element) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            const content = document.getElementById('content-area');
            content.innerHTML = "";

            if (page === 'matches') renderMyMatch();
            else if (page === 'tournaments') renderTournaments();
            // ... boshqa sahifalar
        }

        function renderMyMatch() {
            const content = document.getElementById('content-area');
            if (!myTeam) {
                content.innerHTML = `<div style="text-align:center; padding-top:50px;">Siz hali turnirda emassiz.</div>`;
                return;
            }
            
            // Misol uchun guruhdagi raqibni topamiz
            const tour = allTournaments[myTournamentId];
            const opponent = (tour.teams || []).find(t => t.player_id && t.player_id != userId) || {name: "Kutilmoqda", flag: ""};

            content.innerHTML = `
                <div class="match-card">
                    <div style="font-size:10px; color:var(--text-gray)">${myTournamentId}</div>
                    <div class="match-vs">
                        <div class="match-team-box"><img src="${myTeam.flag}"> ${myTeam.name}</div>
                        <div class="vs-label">VS</div>
                        <div class="match-team-box"><img src="${opponent.flag}"> ${opponent.name}</div>
                    </div>
                    <div class="upload-area" id="drop-zone" onclick="document.getElementById('file-input').click()">
                        <div id="status-text">O'yin hisobi skrinshotini yuklang</div>
                        <input type="file" id="file-input" hidden accept="image/*" onchange="processMatchAI(this)">
                        <img id="preview-img">
                        <div id="ai-status"></div>
                    </div>
                </div>
            `;
        }

        window.processMatchAI = async function(input) {
            const file = input.files[0];
            if (!file) return;

            const preview = document.getElementById('preview-img');
            const aiStatus = document.getElementById('ai-status');
            const dropZone = document.getElementById('drop-zone');

            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
            aiStatus.innerHTML = "AI rasmni tahlil qilmoqda... ⏳";
            dropZone.classList.add('processing');

            try {
                // Skrinshotni o'qish (Ingliz va O'zbek lug'ati bilan)
                const result = await Tesseract.recognize(file, 'eng+uzb', {
                    logger: m => console.log(m)
                });
                
                const text = result.data.text.toLowerCase();
                console.log("Tanilgan matn:", text);

                // 1. Jamoani tekshirish (Siz tanlagan: O'zbekiston)
                const myTeamName = myTeam.name.toLowerCase();
                const teamFound = text.includes(myTeamName) || text.includes("uzbekistan") || text.includes("o'zbekiston");

                // 2. Hisobni aniqlash (X - Y formatida)
                const scorePattern = /(\d)\s*[-:]\s*(\d)/;
                const match = text.match(scorePattern);

                if (teamFound && match) {
                    const score1 = match[1];
                    const score2 = match[2];

                    // Tizim jamoalar tartibiga qarab hisobni ajratadi
                    // Agar O'zbekiston chapda bo'lsa score1, o'ngda bo'lsa score2
                    const myScore = text.indexOf(myTeamName) < text.indexOf(match[0]) ? score1 : score2;
                    const oppScore = myScore === score1 ? score2 : score1;

                    aiStatus.innerHTML = `AI natijani aniqladi: <br> <b style="font-size:20px; color:white;">${myScore} - ${oppScore}</b>`;
                    
                    tg.showConfirm(`AI tahlili: ${myTeam.name} ${myScore} - ${oppScore} Raqib. Tasdiqlaysizmi?`, async (ok) => {
                        if (ok) {
                            await set(ref(db, `results/${myTournamentId}/${userId}`), {
                                player: userData.firstName + " " + userData.lastName,
                                team: myTeam.name,
                                score: `${myScore}-${oppScore}`,
                                date: new Date().toISOString()
                            });
                            tg.showAlert("Natija bazaga muvaffaqiyatli saqlandi! ✅");
                        }
                    });
                } else {
                    aiStatus.innerHTML = `<span style="color:var(--konami-red)">AI natijani aniqlay olmadi. Iltimos, jamoalar va hisob aniq ko'ringan rasmni yuklang.</span>`;
                }
            } catch (e) {
                tg.showAlert("Xatolik: Rasmni qayta ishlashda muammo yuz berdi.");
            } finally {
                dropZone.classList.remove('processing');
            }
        }

        startAppInit();
    </script>
</body>
</html>
